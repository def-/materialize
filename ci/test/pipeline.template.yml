# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# This file is processed by mkpipeline.py to trim unnecessary steps in PR
# builds. The inputs for steps using the `mzcompose` plugin are computed
# automatically. Inputs for other steps need to be manually listed in the
# `inputs` key.

dag: true

env:
  CI_BUILDER_SCCACHE: 1

steps:
  - id: cargo-test
    label: Cargo test
    timeout_in_minutes: 30
    artifact_paths: [junit_*.xml, target/nextest/ci/junit_cargo-test.xml]
    inputs:
      - Cargo.lock
      - "**/Cargo.toml"
      - "**/*.rs"
      - "**/*.proto"
      - "**/testdata/**"
    env:
      AWS_DEFAULT_REGION: "us-east-1"
      # cargo-test's coverage is handled separately by cargo-llvm-cov
      BUILDKITE_MZCOMPOSE_PLUGIN_SKIP_COVERAGE: "true"
    plugins:
      - ./ci/plugins/scratch-aws-access: ~
      - ./ci/plugins/mzcompose:
          composition: cargo-test
    agents:
      queue: builder-linux-x86_64
    retry:
      automatic:
        - exit_status: 0
          limit: 10
        - exit_status: "*"
          limit: 10

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# This file is processed by mkpipeline.py to trim unnecessary steps in PR
# builds. The inputs for steps using the `mzcompose` plugin are computed
# automatically. Inputs for other steps need to be manually listed in the
# `inputs` key.

dag: true

env:
  CI_BUILDER_SCCACHE: 1
  # Note: In .cargo/config we set the default build jobs to -1 so on developer machines we keep
  # a single core open when compiling. But we want to use all of CI's resources, hence setting the
  # build jobs to "default" which will use all cores.
  CARGO_BUILD_JOBS: "default"

steps:
  - id: build-x86_64
    label: Build x86_64
    command: bin/ci-builder run stable bin/pyactivate -m ci.test.build
    inputs:
      - "*"
    timeout_in_minutes: 60
    priority: 1
    agents:
      queue: builder-linux-x86_64

  - id: build-aarch64
    label: Build aarch64
    command: bin/ci-builder run stable bin/pyactivate -m ci.test.build
    inputs:
      - "*"
    priority: 1
    timeout_in_minutes: 60
    branches: "main v*.*"
    agents:
      queue: builder-linux-aarch64
    coverage: skip

  - id: build-wasm
    label: Build WASM
    command: bin/ci-builder run stable bin/pyactivate -m ci.deploy.npm --no-release
    inputs:
      - "*"
    timeout_in_minutes: 10
    agents:
      queue: linux-x86_64
    coverage: skip

  - id: devel-docker-tags
    label: Tag development docker images
    command: bin/ci-builder run stable bin/pyactivate -m ci.test.dev_tag
    inputs:
      - "*"
    depends_on:
      - build-x86_64
      - build-aarch64
    timeout_in_minutes: 10
    agents:
      queue: linux-x86_64
    coverage: skip

  - id: checks-restart-environmentd-clusterd-storage
    label: "Checks + restart of environmentd & storage clusterd"
    depends_on: build-x86_64
    inputs: [misc/python/materialize/checks]
    timeout_in_minutes: 30
    artifact_paths: junit_*.xml
    agents:
      queue: linux-x86_64
    plugins:
      - ./ci/plugins/mzcompose:
          composition: platform-checks
          args: [--scenario=RestartEnvironmentdClusterdStorage, "--seed=$BUILDKITE_JOB_ID"]
    retry:
      manual:
        permit_on_passed: true

  - id: analyze
    label: Analyze tests
    inputs: ["*"]
    plugins:
      - junit-annotate#v2.0.2:
          artifacts: "*junit_*.xml"
          job-uuid-file-pattern: _([^_]*).xml
    priority: 1
    agents:
      queue: linux-x86_64
